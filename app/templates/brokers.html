{% extends "base.html" %}
{% block title %}Brokers{% endblock %}

{% block content %}
<div class="page-header mb-4 d-flex justify-content-between align-items-end">
  <div>
    <h2><i class="bi bi-building me-2"></i>Broker Registry</h2>
    <p class="text-muted">{{ brokers | length }} brokers tracked. Click an opt-out URL to open it manually.</p>
  </div>
  <a href="/run" class="btn btn-primary">
    <i class="bi bi-play-circle me-1"></i> Run Scan
  </a>
</div>

{% set method_badges = {
  'web_form': ('primary', 'browser'),
  'email':    ('info', 'envelope'),
  'manual':   ('secondary', 'hand-index')
} %}

{% set status_badges = {
  'confirmed':       'success',
  'submitted':       'primary',
  'pending':         'warning',
  'manual_required': 'info',
  'error':           'danger',
  'denied':          'danger',
  'expired':         'secondary'
} %}

<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-dark">
          <tr>
            <th>Broker</th>
            <th>Method</th>
            <th>Status</th>
            <th>Last Submitted</th>
            <th>Avg. Days</th>
            <th>Opt-Out Link</th>
          </tr>
        </thead>
        <tbody>
          {% for b in brokers %}
          <tr>
            <td>
              <div class="fw-semibold">{{ b.name }}</div>
              {% if b.notes %}
              <small class="text-muted">{{ b.notes }}</small>
              {% endif %}
            </td>
            <td>
              {% set badge, icon = method_badges.get(b.method, ('secondary', 'question')) %}
              <span class="badge bg-{{ badge }}">
                <i class="bi bi-{{ icon }} me-1"></i>{{ b.method | replace('_', ' ') }}
              </span>
            </td>
            <td>
              {% if b.last_status %}
                <span class="badge bg-{{ status_badges.get(b.last_status, 'secondary') }}">
                  {{ b.last_status | replace('_', ' ') | title }}
                </span>
              {% else %}
                <span class="badge bg-light text-muted border">Not submitted</span>
              {% endif %}
            </td>
            <td class="text-muted small">
              {{ b.last_submitted[:16] if b.last_submitted else 'â€”' }}
            </td>
            <td class="text-muted text-center">
              {{ b.avg_response_days }}d
            </td>
            <td>
              <a href="{{ b.opt_out_url }}" target="_blank" rel="noopener"
                 class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-box-arrow-up-right"></i>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
